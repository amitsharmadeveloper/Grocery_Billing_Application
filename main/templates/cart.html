{% load static %}
{% load custom_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart</title>
  <link rel="stylesheet" href="{% static 'css/cart.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <div class="navbar">
    <div class="logo">BillYear</div>
    <div class="nav-links" id="navLinks">
      <a href="/home/">Home</a>
      <a href="/cart/">Cart </a>
      <a href="/search/">Search</a>
      <a href="/sales_report/">Sales Report</a>
      <a href="/order_history/">Order History</a>
      <a href="{% url 'supplier_payment' %}">supplier_payment</a>
      <a href="/contact/">Contact Us</a>
    </div>
    <div class="hamburger" onclick="toggleMenu()">â˜°</div>
  </div>
  <h1>Your Cart</h1>

  {% if cart_items or show_bill_buttons %}
    {% if cart_items %}
      {% for item in cart_items %}
        <div class="cart-box">
          <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" />
          <div class="divider"></div>
          <div class="details">
            <h3>{{ item.product.name }}</h3>
            <p>Price: â‚¹{{ item.product.price }}</p>
            
            <p>Available Stock: <span id="stock-{{ item.product.id }}">{{ item.product.stock }}</span></p>

            <div class="qty-control">
              <form method="post" action="{% url 'update_quantity' item.product.id %}">
                {% csrf_token %}
                <input type="hidden" name="initial_stock" value="{{ item.product.stock }}" />
                <input type="hidden" name="browser_qty" value="{{ request.session|get_browser_qty:item.product.id|default:0 }}" />
                <button type="submit" name="action" value="decrease">-</button>
                <span>{{ request.session|get_browser_qty:item.product.id|default:0 }}</span>
                <button type="submit" name="action" value="increase">+</button>
              </form>

              {% if item.product.stock < 5 %}
                <p style="color: yellow; margin: 0; font-weight: bold">
                  âš  Low stock alert for {{ item.product.name }} (Only {{ item.product.stock }} left)
                </p>
              {% endif %}

              <form method="post" action="{% url 'remove_from_cart' item.product.id %}">
                {% csrf_token %}
                <button type="submit" class="remove-btn">Remove</button>
              </form>
            </div>

            <div class="subtotal">
              <p>Subtotal: â‚¹{{ item.product.price|floatformat:2 }} Ã— {{ item.quantity }} = â‚¹{{ item.item_total|floatformat:2 }}</p>
            </div>
          </div>
        </div>
      {% endfor %}

      <div class="total-box">
        <strong>Total: â‚¹<span id="cart-total-amount">{{ total_price|floatformat:2 }}</span></strong>
      </div>
    {% endif %}

     

    <!-- Form Section -->
    <form method="POST" action="{% url 'save_cart_to_db' %}">
      {% csrf_token %}
      <div class="form-card">
        <div class="form-row">
          <label for="phone_number">ðŸ“ž Phone Number:</label>
          <input type="text" name="phone_number" placeholder="Enter Phone Number" required />
        </div>

        <div class="form-row">
          <label class="displaying">ðŸ’³ Select Payment Method:</label>
          <div class="radio-group">
            {% for method in payment_options %}
              <div class="radio-item">
                <input type="radio" id="{{ method|slugify }}" name="payment_method" value="{{ method }}">
                <label for="{{ method|slugify }}">{{ method }}</label>
              </div>
            {% endfor %}
          </div>
          
        </div>

        <div class="form-row">
          <label>Is Payment Due?</label>
          <label><input type="radio" name="payment_due" value="yes" onchange="toggleDue(true)"> Yes</label>
          <label><input type="radio" name="payment_due" value="no" onchange="toggleDue(false)"> No</label>
        </div>

        <div class="form-row" id="due-amount-field" style="display:none;">
          <label for="due_amount">Enter Due Amount:</label>
          <input type="number" name="due_amount" placeholder="â‚¹ Amount" step="0.01" />
        </div>

        <div class="form-row">
          <label><input type="checkbox" name="payment_done" /> Payment Done</label>
        </div>

        <div class="form-row">
          <label for="customer_name">Customer Name:</label>
          <input type="text" name="customer_name" placeholder="Enter Customer Name" required />
        </div>

        <div class="form-row">
          <button type="submit" class="pay-button">Confirm Cart</button>
        </div>
      </div>
    </form>

    {% if show_bill_buttons %}
      <div class="bill-buttons" style="margin-left:330px;">
        <a href="{% url 'generate_bill' 'pdf' %}" class="generate-bill-button" style="border-radius:30px;">Bill in PDF Format</a>
        <a href="{% url 'generate_bill' 'image' %}" class="generate-bill-button" style="border-radius:30px;">Bill in Image Format</a>
      </div>
    {% endif %}
  {% else %}
    <p class="empty-card">Your cart is empty.</p>
  {% endif %}

  <script src="{% static 'js/cart.js' %}"></script>
  <script src="{% static 'js/menu.js' %}" defer></script>
</body>
</html>
